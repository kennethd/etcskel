#!/bin/bash
logger "running backup-mysql for $LOGNAME"
set -x

# backup-mysql 
# dumps a schema-only ddl and a gzipped full-data backup of your database(s)

DATEI="$( date +'%Y-%m-%d' )"
DATEW="$( date +'%w' )"
HOST="$( hostname )"

# override by exporting non-default value before calling
[ -z "$BACKUP_MYSQL_DIR" ] && BACKUP_MYSQL_DIR="$HOME/backups/mysql"
[ -z "$BACKUP_ETC" ] && BACKUP_ETC="$HOME/etc/backup"
[ -z "$BACKUP_MYSQL_KEEP_DAYS" ] && BACKUP_MYSQL_KEEP_DAYS=3

if [ ! -e "$BACKUP_ETC" ]; then mkdir -p "$BACKUP_ETC"; fi
if [ ! -r "$BACKUP_ETC" ] || [ ! -w "$BACKUP_ETC" ]; then exit 1; fi

# allow disabling backups by touching a file
if [ -e "$BACKUP_ETC/disable" ] || [ -e "$BACKUP_ETC/disabled" ]; then exit 0; fi

if [ ! -e "$BACKUP_MYSQL_DIR" ]; then mkdir -p "$BACKUP_MYSQL_DIR"; fi
if [ ! -w "$BACKUP_MYSQL_DIR" ]; then exit 1; fi

# delete old backups 
find "$BACKUP_MYSQL_DIR" -daystart -mtime +$BACKUP_MYSQL_KEEP_DAYS -type f -print0 | xargs -r -0 rm -f

mysqldump --opt | gzip > "$BUDIR"/mysqldump.$HOST.$LOGNAME.$DATEI.sql.gz
mysqldump --opt --no-data > "$BUDIR"/mysqldump.$HOST.$LOGNAME.$DATEI.ddl
